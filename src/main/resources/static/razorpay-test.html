<!DOCTYPE html>
<html>
<head>
    <title>Razorpay Payment Test</title>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
</head>

<body style="font-family: Arial; padding: 40px; background: #f7f7f7;">

<h2>Razorpay Payment Test</h2>
<p>Click the button to simulate a real Razorpay payment.</p>

<label>JWT Token:</label><br>
<input type="text" id="jwt" style="width:500px; padding:8px;"
       placeholder="Paste JWT token here" /><br><br>

<button id="payBtn"
        style="padding: 12px 30px; background:#0B74E5; color:white; border:none; border-radius:8px; cursor:pointer;">
    Pay Now
</button>

<script>
    document.getElementById("payBtn").onclick = async function() {

        const TOKEN = document.getElementById("jwt").value.trim();
        if (!TOKEN) {
            alert("⚠️ Please enter JWT token first");
            return;
        }

        // STEP 1 — Fetch latest order of logged in user
        const orderRes = await fetch("http://localhost:8989/aimdev/api/orders/my", {
            method: "GET",
            headers: {
                "Authorization": "Bearer " + TOKEN,
                "Content-Type": "application/json"
            }
        });

        const orderData = await orderRes.json();
        console.log("My Orders:", orderData);

        const latestOrder = orderData.data.data[0]; // first (latest)

        if (!latestOrder) {
            alert("❌ No orders found for this user.");
            return;
        }

        const orderId = latestOrder.orderId;
        console.log("Using Order:", orderId);

        // STEP 2 — Create Razorpay order
        const createRes = await fetch("http://localhost:8989/aimdev/api/payment/create", {
            method: "POST",
            headers: {
                "Authorization": "Bearer " + TOKEN,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ orderId: orderId })
        });

        const createData = await createRes.json();
        const info = createData.data.data;

        console.log("Created Razorpay Order:", info);

        // STEP 3 — Open Razorpay popup
        const options = {
            key: info.key,
            amount: info.amount,
            currency: info.currency,
            order_id: info.razorpayOrderId,

            name: "OneAim Store",
            description: "Order Payment",

            handler: async function (response) {
                console.log("Payment Success:", response);

                // STEP 4 — Verify payment
                const verifyRes = await fetch("http://localhost:8989/aimdev/api/payment/verify", {
                    method: "POST",
                    headers: {
                        "Authorization": "Bearer " + TOKEN,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        orderId: info.orderId,
                        razorpayOrderId: response.razorpay_order_id,
                        razorpayPaymentId: response.razorpay_payment_id,
                        razorpaySignature: response.razorpay_signature
                    })
                });

                const verifyData = await verifyRes.json();
                console.log("Verify Response:", verifyData);
                alert("Payment Completed: " + JSON.stringify(verifyData));
            },

            theme: { color: "#0B74E5" }
        };

        const rzp = new Razorpay(options);
        rzp.open();
    };
</script>

</body>
</html>
